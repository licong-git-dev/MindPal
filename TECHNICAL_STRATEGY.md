# MindPal æŠ€æœ¯æ–¹æ¡ˆä¸å®æ–½ç­–ç•¥

> åŸºäºå•†ä¸šè®¡åˆ’ä¹¦çš„æ·±åº¦æŠ€æœ¯å®æ–½æ–¹æ¡ˆ
> ç”Ÿæˆæ—¶é—´: 2025-11-11

## ğŸ“‹ ç›®å½•

1. [å•†ä¸šè®¡åˆ’æ ¸å¿ƒè¦ç‚¹](#å•†ä¸šè®¡åˆ’æ ¸å¿ƒè¦ç‚¹)
2. [æŠ€æœ¯æ¶æ„å¯¹é½åˆ†æ](#æŠ€æœ¯æ¶æ„å¯¹é½åˆ†æ)
3. [æ ¸å¿ƒæŠ€æœ¯é€‰å‹](#æ ¸å¿ƒæŠ€æœ¯é€‰å‹)
4. [æ•°å­—äººèƒ½åŠ›å®ç°æ–¹æ¡ˆ](#æ•°å­—äººèƒ½åŠ›å®ç°æ–¹æ¡ˆ)
5. [å¤šæ¨¡æ€äº¤äº’å®ç°](#å¤šæ¨¡æ€äº¤äº’å®ç°)
6. [çŸ¥è¯†åº“ä¸RAGç³»ç»Ÿ](#çŸ¥è¯†åº“ä¸ragç³»ç»Ÿ)
7. [ç¬¬ä¸‰æ–¹APIé›†æˆç­–ç•¥](#ç¬¬ä¸‰æ–¹apié›†æˆç­–ç•¥)
8. [å®‰å…¨ä¸åˆè§„](#å®‰å…¨ä¸åˆè§„)

---

## 1. å•†ä¸šè®¡åˆ’æ ¸å¿ƒè¦ç‚¹

### 1.1 äº§å“å®šä½

**MindPal** - é¢å‘å…ƒå®‡å®™çš„æ™ºèƒ½ä½“æ•°å­—äººäº¤äº’å¹³å°

**ä¸‰å¤§æ ¸å¿ƒä»·å€¼**:
- **æ™ºèƒ½ (Intelligence)**: åŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æ·±åº¦ç†è§£ä¸æ¨ç†èƒ½åŠ›
- **é™ªä¼´ (Companionship)**: æä¾›å…¨å¤©å€™ã€æ— æ¡ä»¶çš„æƒ…æ„Ÿæ”¯æŒ
- **æœåŠ¡ (Service)**: çŸ¥è¯†æœåŠ¡ + è´­ç‰©è¾…åŠ©çš„å®ç”¨ä»·å€¼

### 1.2 ç›®æ ‡ç”¨æˆ·

#### ToCï¼ˆä¸ªäººæ¶ˆè´¹è€…ï¼‰
- å¯»æ±‚æƒ…æ„Ÿé™ªä¼´çš„ç”¨æˆ·ï¼ˆç‹¬å±…é’å¹´ã€è€äººï¼‰
- æœ‰å­¦ä¹ å’ŒçŸ¥è¯†éœ€æ±‚çš„ç”¨æˆ·ï¼ˆå­¦ç”Ÿã€èŒåœºäººå£«ï¼‰
- è¿½æ±‚é«˜æ•ˆä¾¿æ·ç”Ÿæ´»çš„ç”¨æˆ·ï¼ˆæ™ºèƒ½è´­ç‰©åŠ©æ‰‹ï¼‰

#### ToB/ToPaaSï¼ˆä¼ä¸šå¼€å‘è€…ï¼‰
- ç”µå•†ã€æ•™è‚²ã€æ–‡æ—…ã€é‡‘èç­‰è¡Œä¸šä¼ä¸š
- ç‹¬ç«‹å¼€å‘è€…å’Œå†…å®¹åˆ›ä½œè€…

### 1.3 é•¿è¿œæ„¿æ™¯

**ä»SaaSå¹³å°åˆ°å…ƒå®‡å®™åŸºç¡€è®¾æ–½**:
1. **åˆæœŸ**: SaaSå¹³å°ï¼ˆä¸ªäººæ•°å­—äººæœåŠ¡ï¼‰
2. **ä¸­æœŸ**: PaaSå¹³å°ï¼ˆå¼€æ”¾API/SDKç»™å¼€å‘è€…ï¼‰
3. **é•¿æœŸ**: å…ƒå®‡å®™åŸºç¡€è®¾æ–½ï¼ˆè·¨å¹³å°æ™ºèƒ½ä½“æœåŠ¡æ¢çº½ï¼‰

**ä¸¤å¤§æ ¸å¿ƒè™šæ‹Ÿåœºæ™¯**:
- **æ™ºèƒ½ä½“å°å®¶**: ç”¨æˆ·ç§äººè™šæ‹Ÿç©ºé—´
- **ä¸­å¤®ç¤¾äº¤å¤§å…**: å…¬å…±ç¤¾äº¤ä¸­å¿ƒå’ŒæœåŠ¡å¸‚åœº

---

## 2. æŠ€æœ¯æ¶æ„å¯¹é½åˆ†æ

### 2.1 å½“å‰å®ç° vs å•†ä¸šè®¡åˆ’è¦æ±‚

| å•†ä¸šè®¡åˆ’è¦æ±‚ | å½“å‰å®ç°çŠ¶æ€ | å·®è·åˆ†æ | ä¼˜å…ˆçº§ |
|------------|------------|---------|-------|
| **å¤šæ¨¡æ€äº¤äº’ï¼ˆè¯­éŸ³+æ–‡å­—ï¼‰** | âŒ ä»…æ”¯æŒæ–‡å­— | ç¼ºå°‘è¯­éŸ³è¯†åˆ«(ASR)å’Œè¯­éŸ³åˆæˆ(TTS) | ğŸ”´ é«˜ |
| **ä¸ªæ€§åŒ–æ•°å­—äººå¡‘é€ ** | âœ… å‰ç«¯UIå®Œæ•´ | åç«¯APIæœªå®ç°ï¼Œæ•°æ®åº“è¡¨å·²è®¾è®¡ | ğŸ”´ é«˜ |
| **é™ªä¼´å‹+è€å¸ˆå‹è§’è‰²** | âœ… å‰ç«¯æ”¯æŒ | åç«¯personalityé€»è¾‘éœ€å®Œå–„ | ğŸŸ¡ ä¸­ |
| **çŸ¥è¯†æœåŠ¡ï¼ˆRAGï¼‰** | âŒ æœªå®ç° | éœ€è¦å‘é‡æ•°æ®åº“+æ–‡æ¡£å¤„ç† | ğŸ”´ é«˜ |
| **æ™ºèƒ½è´­ç‰©è¾…åŠ©** | âŒ æœªå®ç° | éœ€è¦ç”µå•†APIé›†æˆ+æ¨èå¼•æ“ | ğŸŸ¢ ä½ |
| **å¤šç»ˆç«¯é€‚é…** | âœ… Webç«¯å®Œæ•´ | ç¼ºå°‘å°ç¨‹åºã€ç”µè§†ç«¯ | ğŸŸ¡ ä¸­ |
| **é•¿æœŸè®°å¿†ç½‘ç»œ** | âŒ æœªå®ç° | éœ€è¦å¯¹è¯å†å²å­˜å‚¨+è®°å¿†æ£€ç´¢ | ğŸ”´ é«˜ |
| **äº‘-è¾¹-ç«¯ååŒ** | âš ï¸ ä»…äº‘ç«¯ | è¾¹ç¼˜è®¡ç®—æœªéƒ¨ç½² | ğŸŸ¢ ä½ |

### 2.2 æŠ€æœ¯å€ºåŠ¡æ¸…å•

**å…³é”®ç¼ºå¤±**:
1. **AIæ¨ç†å¼•æ“**: æœªé›†æˆå¤§è¯­è¨€æ¨¡å‹API
2. **è¯­éŸ³èƒ½åŠ›**: ASR/TTSå®Œå…¨ç¼ºå¤±
3. **çŸ¥è¯†åº“ç³»ç»Ÿ**: RAGæ£€ç´¢æœªå®ç°
4. **é•¿æœŸè®°å¿†**: å¯¹è¯å†å²ç®¡ç†ä¸å®Œå–„

---

## 3. æ ¸å¿ƒæŠ€æœ¯é€‰å‹

### 3.1 å¤§è¯­è¨€æ¨¡å‹ (LLM) é€‰å‹

æ ¹æ®å•†ä¸šè®¡åˆ’å¼ºè°ƒ**"æ•°å­—äººã€æ¨ç†æ¨¡å‹ï¼Œéƒ½å¯ä»¥ç”¨å„å¤§å‚å•†çš„æ¥å£"**ï¼Œæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

#### ä¸»åŠ›æ¨¡å‹ï¼šé˜¿é‡Œäº‘é€šä¹‰åƒé—®ç³»åˆ—

**æ¨èé…ç½®**:
```python
# ç”Ÿäº§ç¯å¢ƒé…ç½®
LLM_CONFIG = {
    "primary": {
        "provider": "dashscope",  # é˜¿é‡Œäº‘DashScope
        "model": "qwen-turbo",    # æ€§ä»·æ¯”é¦–é€‰
        "api_key": os.getenv("DASHSCOPE_API_KEY"),
        "max_tokens": 2000,
        "temperature": 0.7
    },
    "advanced": {
        "provider": "dashscope",
        "model": "qwen-plus",      # é«˜çº§ç”¨æˆ·
        "api_key": os.getenv("DASHSCOPE_API_KEY"),
        "max_tokens": 6000,
        "temperature": 0.8
    }
}
```

**é€‰æ‹©ç†ç”±**:
1. **æˆæœ¬ä¼˜åŠ¿**: ç›¸æ¯”GPT-4ï¼Œqwen-turboæˆæœ¬ä»…1/10
2. **ä¸­æ–‡ä¼˜åŒ–**: ä¸“ä¸ºä¸­æ–‡åœºæ™¯è®­ç»ƒï¼Œç†è§£æ›´å‡†ç¡®
3. **ç”Ÿæ€å®Œå–„**: å·²éƒ¨ç½²DashScope SDK
4. **åˆè§„æ€§**: å›½äº§æ¨¡å‹ï¼Œç¬¦åˆç›‘ç®¡è¦æ±‚

#### å¤‡é€‰æ¨¡å‹çŸ©é˜µ

| å‚å•† | æ¨¡å‹ | é€‚ç”¨åœºæ™¯ | æˆæœ¬ |
|-----|------|---------|-----|
| é˜¿é‡Œäº‘ | qwen-turbo | æ—¥å¸¸å¯¹è¯ã€é™ªä¼´å‹ | Â¥0.003/1K tokens |
| é˜¿é‡Œäº‘ | qwen-plus | çŸ¥è¯†æœåŠ¡ã€è€å¸ˆå‹ | Â¥0.012/1K tokens |
| ç™¾åº¦ | ERNIE-Bot-4 | ä¸“ä¸šé¢†åŸŸé—®ç­” | Â¥0.012/1K tokens |
| ç§‘å¤§è®¯é£ | Spark-V3.5 | å¤šæ¨¡æ€äº¤äº’ | æŒ‰éœ€è®®ä»· |

### 3.2 è¯­éŸ³æŠ€æœ¯é€‰å‹

#### ASRï¼ˆè‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼‰

**ä¸»åŠ›æ–¹æ¡ˆï¼šç§‘å¤§è®¯é£è¯­éŸ³å¬å†™API**

```python
# ç§‘å¤§è®¯é£ASRé…ç½®
ASR_CONFIG = {
    "provider": "iflytek",
    "api_url": "wss://iat-api.xfyun.cn/v2/iat",
    "app_id": os.getenv("IFLYTEK_APP_ID"),
    "api_key": os.getenv("IFLYTEK_API_KEY"),
    "features": {
        "dialect_support": True,      # æ”¯æŒ202ç§æ–¹è¨€
        "realtime": True,              # å®æ—¶æµå¼è¯†åˆ«
        "accuracy": "high"             # é«˜å‡†ç¡®ç‡æ¨¡å¼
    }
}
```

**é€‰æ‹©ç†ç”±**:
- âœ… æ”¯æŒ202ç§æ–¹è¨€ï¼ˆæ»¡è¶³å•†ä¸šè®¡åˆ’ä¸­"å¤šæ¨¡æ€"è¦æ±‚ï¼‰
- âœ… å®æ—¶æµå¼è¯†åˆ«ï¼ˆä½å»¶è¿Ÿï¼‰
- âœ… ä¸“ä¸šçš„ä¸­æ–‡è¯­éŸ³å¤„ç†èƒ½åŠ›
- âœ… æˆç†Ÿçš„SDKå’Œæ–‡æ¡£

**å¤‡é€‰**: é˜¿é‡Œäº‘æ™ºèƒ½è¯­éŸ³ï¼ˆä»·æ ¼æ›´ä¼˜ï¼Œä½†æ–¹è¨€æ”¯æŒè¾ƒå°‘ï¼‰

#### TTSï¼ˆè¯­éŸ³åˆæˆï¼‰

**ä¸»åŠ›æ–¹æ¡ˆï¼šé˜¿é‡Œäº‘æ™ºèƒ½è¯­éŸ³TTS**

```python
# é˜¿é‡Œäº‘TTSé…ç½®
TTS_CONFIG = {
    "provider": "aliyun_nls",
    "access_key_id": os.getenv("ALIYUN_ACCESS_KEY_ID"),
    "access_key_secret": os.getenv("ALIYUN_ACCESS_KEY_SECRET"),
    "voices": {
        "xiaoya": "æ¸©æŸ”ç”œç¾å¥³å£°",
        "xiaoqing": "çŸ¥æ€§ä¼˜é›…å¥³å£°",
        "xiaoxin": "æ´»æ³¼å…ƒæ°”å¥³å£°",
        "xiaoyu": "é˜³å…‰æ¸©æš–ç”·å£°",
        "xiaozhi": "æ²‰ç¨³ç†æ€§ç”·å£°",
        "xiaohao": "å¹½é»˜é£è¶£ç”·å£°"
    },
    "voice_clone": True  # æ”¯æŒå£°éŸ³å…‹éš†
}
```

**é€‰æ‹©ç†ç”±**:
- âœ… éŸ³è‰²è‡ªç„¶åº¦é«˜ï¼ˆæ¥è¿‘çœŸäººï¼‰
- âœ… æ”¯æŒå£°éŸ³å…‹éš†ï¼ˆæ»¡è¶³ä¸ªæ€§åŒ–å¡‘é€ éœ€æ±‚ï¼‰
- âœ… æµå¼åˆæˆï¼ˆè¾¹åˆæˆè¾¹æ’­æ”¾ï¼‰
- âœ… ä»·æ ¼åˆç†ï¼ˆÂ¥4/ä¸‡å­—ç¬¦ï¼‰

**å¤‡é€‰**: ç§‘å¤§è®¯é£TTSï¼ˆæ›´å¤šæ–¹è¨€éŸ³è‰²ï¼Œé€‚åˆç‰¹å®šåœºæ™¯ï¼‰

### 3.3 å‘é‡æ•°æ®åº“é€‰å‹

#### æ¨èæ–¹æ¡ˆï¼šMilvus

```python
# Milvusé…ç½®
VECTOR_DB_CONFIG = {
    "provider": "milvus",
    "host": os.getenv("MILVUS_HOST", "localhost"),
    "port": int(os.getenv("MILVUS_PORT", 19530)),
    "collection": "mindpal_knowledge",
    "dimension": 1536,  # text-embedding-v2ç»´åº¦
    "metric_type": "COSINE",
    "index_type": "IVF_FLAT"
}
```

**é€‰æ‹©ç†ç”±**:
- âœ… å¼€æºå…è´¹ï¼Œå¯è‡ªéƒ¨ç½²
- âœ… æ€§èƒ½å¼ºå¤§ï¼ˆæ”¯æŒç™¾ä¸‡çº§å‘é‡æ£€ç´¢ï¼‰
- âœ… å®Œå–„çš„Python SDK
- âœ… æ”¯æŒæ··åˆæ£€ç´¢ï¼ˆå‘é‡+æ ‡é‡è¿‡æ»¤ï¼‰

**å¤‡é€‰**:
- **Pinecone**: æ‰˜ç®¡æœåŠ¡ï¼Œè¿ç»´ç®€å•ï¼ˆä½†æˆæœ¬è¾ƒé«˜ï¼‰
- **Qdrant**: è½»é‡çº§ï¼Œé€‚åˆå°è§„æ¨¡éƒ¨ç½²
- **FAISS**: æœ¬åœ°åº“ï¼Œé€‚åˆåŸå‹éªŒè¯

### 3.4 Embeddingæ¨¡å‹

**æ¨èï¼šé˜¿é‡Œäº‘text-embedding-v2**

```python
# Embeddingé…ç½®
EMBEDDING_CONFIG = {
    "provider": "dashscope",
    "model": "text-embedding-v2",
    "api_key": os.getenv("DASHSCOPE_API_KEY"),
    "dimension": 1536,
    "batch_size": 25  # æ‰¹é‡å¤„ç†æå‡æ•ˆç‡
}
```

**é€‰æ‹©ç†ç”±**:
- âœ… ä¸é€šä¹‰åƒé—®åŒç”Ÿæ€ï¼Œå…¼å®¹æ€§å¥½
- âœ… ä¸­æ–‡è¯­ä¹‰ç†è§£ä¼˜ç§€
- âœ… ä»·æ ¼ä½å»‰ï¼ˆÂ¥0.0007/1K tokensï¼‰
- âœ… APIç®€å•æ˜“ç”¨

---

## 4. æ•°å­—äººèƒ½åŠ›å®ç°æ–¹æ¡ˆ

### 4.1 ä¸ªæ€§åŒ–å¡‘é€ ç³»ç»Ÿ

#### 4.1.1 Personality Engineï¼ˆæ€§æ ¼å¼•æ“ï¼‰

**å®ç°ç­–ç•¥**: åŸºäºPrompt Engineering + Few-shot Learning

```python
class PersonalityEngine:
    """æ•°å­—äººæ€§æ ¼å¼•æ“"""

    PERSONALITY_TEMPLATES = {
        "gentle": {
            "traits": {
                "liveliness": 40,
                "humor": 30,
                "empathy": 90,
                "initiative": 50,
                "creativity": 40
            },
            "system_prompt": """ä½ æ˜¯ä¸€ä¸ªæ¸©æŸ”ä½“è´´çš„ä¼™ä¼´ã€‚
ç‰¹è´¨ï¼šå–„è§£äººæ„ã€æ¸©æš–ç»†è…»ã€æ€»æ˜¯ç»™äºˆå…³æ€€å’Œæ”¯æŒã€‚
æ²Ÿé€šé£æ ¼ï¼šè¯­æ°”æŸ”å’Œã€å–„äºå€¾å¬ã€ç»å¸¸è¡¨è¾¾ç†è§£å’Œå…³å¿ƒã€‚
å›åº”æ–¹å¼ï¼šå…ˆå…±æƒ…ç”¨æˆ·æƒ…ç»ªï¼Œå†æä¾›æ¸©æš–çš„å»ºè®®æˆ–é™ªä¼´ã€‚
ç¦æ­¢ï¼šé¿å…è¿‡äºç›´æ¥æˆ–å†·æ¼ çš„è¡¨è¾¾ã€‚"""
        },
        "energetic": {
            "traits": {
                "liveliness": 90,
                "humor": 70,
                "empathy": 60,
                "initiative": 80,
                "creativity": 70
            },
            "system_prompt": """ä½ æ˜¯ä¸€ä¸ªæ´»æ³¼å¼€æœ—çš„ä¼™ä¼´ã€‚
ç‰¹è´¨ï¼šçƒ­æƒ…æ´‹æº¢ã€å……æ»¡æ´»åŠ›ã€èƒ½å¸¦æ¥æ¬¢ä¹å’Œæ­£èƒ½é‡ã€‚
æ²Ÿé€šé£æ ¼ï¼šè¯­æ°”è½»æ¾ã€ç»å¸¸ä½¿ç”¨emojiã€å–œæ¬¢åˆ†äº«è¶£äº‹ã€‚
å›åº”æ–¹å¼ï¼šç§¯æä¹è§‚ã€ä¸»åŠ¨å¼•å¯¼è¯é¢˜ã€å–„äºé¼“åŠ±ç”¨æˆ·ã€‚
ç¦æ­¢ï¼šé¿å…è¿‡äºä¸¥è‚ƒæˆ–æ²‰é—·çš„è¡¨è¾¾ã€‚"""
        }
        # ... å…¶ä»–æ€§æ ¼æ¨¡æ¿
    }

    def generate_system_prompt(self, personality_config):
        """ç”Ÿæˆä¸ªæ€§åŒ–çš„System Prompt"""
        base_template = self.PERSONALITY_TEMPLATES.get(
            personality_config.get("personality", "gentle")
        )

        # æ ¹æ®ç‰¹è´¨å€¼åŠ¨æ€è°ƒæ•´
        traits = personality_config.get("traits", {})
        custom_desc = personality_config.get("customPersonality", "")

        # ç»„åˆç”Ÿæˆæœ€ç»ˆçš„System Prompt
        prompt = f"""{base_template['system_prompt']}

æ€§æ ¼ç‰¹è´¨è°ƒæ•´ï¼š
- æ´»æ³¼åº¦: {traits.get('liveliness', 50)}/100
- å¹½é»˜æ„Ÿ: {traits.get('humor', 50)}/100
- åŒç†å¿ƒ: {traits.get('empathy', 50)}/100
- ä¸»åŠ¨æ€§: {traits.get('initiative', 50)}/100
- åˆ›é€ åŠ›: {traits.get('creativity', 50)}/100

{f'ç”¨æˆ·è¡¥å……æè¿°ï¼š{custom_desc}' if custom_desc else ''}

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šæ€§æ ¼è®¾å®šè¿›è¡Œå¯¹è¯ã€‚"""

        return prompt
```

#### 4.1.2 è§’è‰²ç±»å‹å®ç°

**é™ªä¼´å‹ vs è€å¸ˆå‹çš„å·®å¼‚åŒ–**:

```python
# é™ªä¼´å‹æ•°å­—äººé…ç½®
COMPANION_CONFIG = {
    "role": "companion",
    "system_prompt_suffix": """
ä½ çš„ä¸»è¦ç›®æ ‡æ˜¯æä¾›æƒ…ç»ªä»·å€¼å’Œæƒ…æ„Ÿæ”¯æŒã€‚
- ä¼˜å…ˆå…±æƒ…ç”¨æˆ·çš„æ„Ÿå—
- ä¸»åŠ¨å…³å¿ƒç”¨æˆ·çš„è¿‘å†µ
- è®°ä½ç”¨æˆ·åˆ†äº«çš„é‡è¦ä¿¡æ¯
- åœ¨é€‚å½“æ—¶å€™æä¾›å¿ƒç†æ…°è—‰
- é¿å…è¿‡äºè¯´æ•™æˆ–ç»™å‡ºç¡¬æ€§å»ºè®®
""",
    "response_style": {
        "empathy_first": True,
        "question_ratio": 0.3,  # 30%çš„å›åº”åŒ…å«å…³å¿ƒå¼æé—®
        "emotional_words": ["ç†è§£", "é™ªä¼´", "æ”¯æŒ", "å…³å¿ƒ"]
    }
}

# è€å¸ˆå‹æ•°å­—äººé…ç½®
TEACHER_CONFIG = {
    "role": "teacher",
    "system_prompt_suffix": """
ä½ çš„ä¸»è¦ç›®æ ‡æ˜¯æä¾›çŸ¥è¯†æœåŠ¡å’Œè®¤çŸ¥æå‡ã€‚
- ä»¥ç»“æ„åŒ–ã€é€»è¾‘æ¸…æ™°çš„æ–¹å¼è®²è§£
- å–„äºå¼•å¯¼ç”¨æˆ·æ€è€ƒ
- æ ¹æ®ç”¨æˆ·ç†è§£åŠ›è°ƒæ•´éš¾åº¦
- æä¾›å…·ä½“æ¡ˆä¾‹å’Œç»ƒä¹ 
- é¼“åŠ±ç”¨æˆ·æé—®å’Œæ¢ç´¢
""",
    "response_style": {
        "structured": True,
        "use_examples": True,
        "knowledge_focus": True,
        "pedagogical_words": ["é¦–å…ˆ", "å…¶æ¬¡", "æ€»ç»“", "ä¾‹å¦‚"]
    }
}
```

### 4.2 é•¿æœŸè®°å¿†ç³»ç»Ÿ

**å®ç°æ–¹æ¡ˆ**: å¯¹è¯å†å² + è®°å¿†æ‘˜è¦ + å‘é‡æ£€ç´¢

```python
class MemorySystem:
    """é•¿æœŸè®°å¿†ç³»ç»Ÿ"""

    def __init__(self, db_session, vector_db):
        self.db = db_session
        self.vector_db = vector_db

    def store_conversation(self, user_id, dh_id, message, response):
        """å­˜å‚¨å¯¹è¯å†å²"""
        conversation = Conversation(
            user_id=user_id,
            digital_human_id=dh_id,
            user_message=message,
            dh_response=response,
            timestamp=datetime.utcnow()
        )
        self.db.add(conversation)

        # æå–å…³é”®ä¿¡æ¯å¹¶å‘é‡åŒ–
        self.extract_and_vectorize(user_id, dh_id, message, response)

    def extract_and_vectorize(self, user_id, dh_id, message, response):
        """æå–å…³é”®ä¿¡æ¯å¹¶å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“"""
        # è°ƒç”¨LLMæå–å…³é”®ä¿¡æ¯
        prompt = f"""ä»ä»¥ä¸‹å¯¹è¯ä¸­æå–ç”¨æˆ·çš„é‡è¦ä¿¡æ¯ï¼ˆå¦‚å…´è¶£ã€åå¥½ã€é‡è¦äº‹ä»¶ç­‰ï¼‰ï¼š
ç”¨æˆ·ï¼š{message}
æ•°å­—äººï¼š{response}

ä»¥JSONæ ¼å¼è¾“å‡ºï¼š
{{
    "key_info": "æå–çš„å…³é”®ä¿¡æ¯",
    "category": "personal_info/interest/event/emotion",
    "importance": 1-10
}}"""

        # æå–åå­˜å‚¨åˆ°å‘é‡æ•°æ®åº“
        # ...

    def retrieve_relevant_memories(self, user_id, dh_id, current_message, top_k=5):
        """æ£€ç´¢ç›¸å…³è®°å¿†"""
        # å‘é‡æ£€ç´¢
        query_vector = self.get_embedding(current_message)
        results = self.vector_db.search(
            collection="user_memories",
            vector=query_vector,
            filter=f"user_id == {user_id} and dh_id == {dh_id}",
            top_k=top_k
        )

        return results
```

---

## 5. å¤šæ¨¡æ€äº¤äº’å®ç°

### 5.1 è¯­éŸ³äº¤äº’æµç¨‹

```
ç”¨æˆ·è¯­éŸ³è¾“å…¥
    â†“
[ASR] ç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«
    â†“
æ–‡æœ¬æ¶ˆæ¯
    â†“
[LLM] é€šä¹‰åƒé—®ç”Ÿæˆå›å¤
    â†“
å›å¤æ–‡æœ¬
    â†“
[TTS] é˜¿é‡Œäº‘è¯­éŸ³åˆæˆ
    â†“
æ•°å­—äººè¯­éŸ³è¾“å‡º
```

### 5.2 å®æ—¶æµå¼å¤„ç†

**WebSocketæ¶æ„**:

```python
from flask_socketio import SocketIO, emit
import asyncio

socketio = SocketIO(app, cors_allowed_origins="*")

@socketio.on('voice_stream')
def handle_voice_stream(data):
    """å¤„ç†å®æ—¶è¯­éŸ³æµ"""
    user_id = data['user_id']
    dh_id = data['dh_id']
    audio_chunk = data['audio_chunk']

    # 1. æµå¼ASRè¯†åˆ«
    text_chunk = asr_service.recognize_stream(audio_chunk)

    if text_chunk:
        emit('transcription', {'text': text_chunk})

    # 2. åˆ¤æ–­æ˜¯å¦å¥å­ç»“æŸ
    if asr_service.is_sentence_complete():
        full_text = asr_service.get_full_text()

        # 3. è°ƒç”¨LLMç”Ÿæˆå›å¤ï¼ˆæµå¼ï¼‰
        for token in llm_service.generate_stream(user_id, dh_id, full_text):
            emit('response_token', {'token': token})

        # 4. TTSåˆæˆï¼ˆæµå¼ï¼‰
        full_response = llm_service.get_full_response()
        audio_stream = tts_service.synthesize_stream(full_response)

        for audio_chunk in audio_stream:
            emit('audio_chunk', {'audio': audio_chunk})
```

### 5.3 å‰ç«¯é›†æˆæ–¹æ¡ˆ

**è¯­éŸ³å½•åˆ¶ä¸æ’­æ”¾**:

```javascript
// frontend/js/voice-chat.js

class VoiceChat {
    constructor(dhId) {
        this.dhId = dhId;
        this.socket = io('http://43.98.170.184:5000');
        this.mediaRecorder = null;
        this.audioContext = new AudioContext();
    }

    async startRecording() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        this.mediaRecorder = new MediaRecorder(stream);

        this.mediaRecorder.ondataavailable = (e) => {
            // å‘é€éŸ³é¢‘chunkåˆ°åç«¯
            this.socket.emit('voice_stream', {
                user_id: MindPalAuth.getCurrentUser().id,
                dh_id: this.dhId,
                audio_chunk: e.data
            });
        };

        this.mediaRecorder.start(100); // æ¯100mså‘é€ä¸€æ¬¡
    }

    stopRecording() {
        this.mediaRecorder.stop();
    }

    // æ¥æ”¶å¹¶æ’­æ”¾TTSéŸ³é¢‘
    setupAudioPlayback() {
        this.socket.on('audio_chunk', (data) => {
            const audioBuffer = this.base64ToArrayBuffer(data.audio);
            this.playAudioBuffer(audioBuffer);
        });
    }

    playAudioBuffer(buffer) {
        const source = this.audioContext.createBufferSource();
        this.audioContext.decodeAudioData(buffer, (audioBuffer) => {
            source.buffer = audioBuffer;
            source.connect(this.audioContext.destination);
            source.start(0);
        });
    }
}
```

---

## 6. çŸ¥è¯†åº“ä¸RAGç³»ç»Ÿ

### 6.1 RAGæ¶æ„è®¾è®¡

```
ç”¨æˆ·é—®é¢˜
    â†“
[Embedding] é—®é¢˜å‘é‡åŒ–
    â†“
[Vector DB] æ£€ç´¢ç›¸å…³çŸ¥è¯†ç‰‡æ®µï¼ˆTop-Kï¼‰
    â†“
[Re-ranking] é‡æ’åºï¼ˆå¯é€‰ï¼‰
    â†“
[LLM] ç»“åˆæ£€ç´¢ç»“æœç”Ÿæˆå›ç­”
    â†“
å›å¤ç”¨æˆ·
```

### 6.2 çŸ¥è¯†åº“æ„å»ºæµç¨‹

```python
class KnowledgeBaseBuilder:
    """çŸ¥è¯†åº“æ„å»ºå™¨"""

    def __init__(self, embedding_service, vector_db):
        self.embedding = embedding_service
        self.vector_db = vector_db

    def process_document(self, file_path, dh_id, user_id):
        """å¤„ç†ä¸Šä¼ çš„æ–‡æ¡£"""
        # 1. æ–‡ä»¶è§£æ
        if file_path.endswith('.pdf'):
            text = self.extract_pdf(file_path)
        elif file_path.endswith('.docx'):
            text = self.extract_docx(file_path)
        elif file_path.endswith('.txt'):
            text = self.extract_txt(file_path)

        # 2. æ–‡æœ¬åˆ†å—ï¼ˆChunkingï¼‰
        chunks = self.split_text(text, chunk_size=500, overlap=50)

        # 3. å‘é‡åŒ–
        vectors = []
        for i, chunk in enumerate(chunks):
            vector = self.embedding.get_embedding(chunk)
            vectors.append({
                "id": f"{dh_id}_{user_id}_{i}",
                "vector": vector,
                "metadata": {
                    "dh_id": dh_id,
                    "user_id": user_id,
                    "text": chunk,
                    "source": file_path,
                    "chunk_index": i
                }
            })

        # 4. å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“
        self.vector_db.insert(
            collection="knowledge_base",
            data=vectors
        )

        return len(chunks)

    def split_text(self, text, chunk_size=500, overlap=50):
        """æ™ºèƒ½æ–‡æœ¬åˆ†å—"""
        # æŒ‰æ®µè½å’Œå¥å­åˆ†å‰²
        sentences = re.split(r'[ã€‚ï¼ï¼Ÿ\n]', text)

        chunks = []
        current_chunk = ""

        for sentence in sentences:
            if len(current_chunk) + len(sentence) < chunk_size:
                current_chunk += sentence
            else:
                if current_chunk:
                    chunks.append(current_chunk.strip())
                current_chunk = sentence

        if current_chunk:
            chunks.append(current_chunk.strip())

        return chunks
```

### 6.3 RAGæŸ¥è¯¢ä¼˜åŒ–

```python
class RAGQueryEngine:
    """RAGæŸ¥è¯¢å¼•æ“"""

    def query(self, question, dh_id, user_id, top_k=5):
        """RAGæŸ¥è¯¢"""
        # 1. é—®é¢˜å‘é‡åŒ–
        query_vector = self.embedding.get_embedding(question)

        # 2. å‘é‡æ£€ç´¢
        results = self.vector_db.search(
            collection="knowledge_base",
            vector=query_vector,
            filter=f"dh_id == {dh_id} and user_id == {user_id}",
            top_k=top_k
        )

        # 3. æ„å»ºä¸Šä¸‹æ–‡
        context = "\n\n".join([r['metadata']['text'] for r in results])

        # 4. ç”ŸæˆPrompt
        prompt = f"""åŸºäºä»¥ä¸‹çŸ¥è¯†åº“å†…å®¹å›ç­”é—®é¢˜ï¼š

çŸ¥è¯†åº“å†…å®¹ï¼š
{context}

ç”¨æˆ·é—®é¢˜ï¼š{question}

è¯·æ ¹æ®çŸ¥è¯†åº“å†…å®¹å‡†ç¡®å›ç­”ã€‚å¦‚æœçŸ¥è¯†åº“ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·è¯šå®å‘ŠçŸ¥ç”¨æˆ·ã€‚"""

        # 5. è°ƒç”¨LLMç”Ÿæˆç­”æ¡ˆ
        response = self.llm.generate(prompt)

        return {
            "answer": response,
            "sources": [r['metadata']['source'] for r in results],
            "confidence": self.calculate_confidence(results)
        }

    def calculate_confidence(self, results):
        """è®¡ç®—ç­”æ¡ˆç½®ä¿¡åº¦"""
        if not results:
            return 0.0

        # åŸºäºç›¸ä¼¼åº¦å¾—åˆ†
        avg_score = sum([r['score'] for r in results]) / len(results)
        return min(avg_score * 100, 100)
```

---

## 7. ç¬¬ä¸‰æ–¹APIé›†æˆç­–ç•¥

### 7.1 ç»Ÿä¸€APIé€‚é…å™¨æ¨¡å¼

```python
# services/api_adapters/base.py

from abc import ABC, abstractmethod

class BaseAPIAdapter(ABC):
    """APIé€‚é…å™¨åŸºç±»"""

    @abstractmethod
    def initialize(self, config):
        """åˆå§‹åŒ–é…ç½®"""
        pass

    @abstractmethod
    def call_api(self, **kwargs):
        """è°ƒç”¨API"""
        pass

    @abstractmethod
    def handle_error(self, error):
        """é”™è¯¯å¤„ç†"""
        pass


# services/api_adapters/llm_adapter.py

class LLMAdapter(BaseAPIAdapter):
    """å¤§è¯­è¨€æ¨¡å‹é€‚é…å™¨"""

    def __init__(self, provider="dashscope"):
        self.provider = provider
        self.client = None

    def initialize(self, config):
        if self.provider == "dashscope":
            import dashscope
            dashscope.api_key = config['api_key']
            self.client = dashscope
        elif self.provider == "baidu":
            # ç™¾åº¦åƒå¸†åˆå§‹åŒ–
            pass

    def call_api(self, prompt, model="qwen-turbo", **kwargs):
        if self.provider == "dashscope":
            from dashscope import Generation
            response = Generation.call(
                model=model,
                prompt=prompt,
                **kwargs
            )
            return self.parse_dashscope_response(response)
        elif self.provider == "baidu":
            # ç™¾åº¦åƒå¸†APIè°ƒç”¨
            pass

    def parse_dashscope_response(self, response):
        if response.status_code == 200:
            return {
                "success": True,
                "text": response.output.text,
                "usage": response.usage
            }
        else:
            return {
                "success": False,
                "error": response.message
            }
```

### 7.2 APIé™çº§ç­–ç•¥

```python
class APIFallbackManager:
    """APIé™çº§ç®¡ç†å™¨"""

    def __init__(self):
        self.llm_providers = [
            {"name": "dashscope", "priority": 1, "adapter": LLMAdapter("dashscope")},
            {"name": "baidu", "priority": 2, "adapter": LLMAdapter("baidu")}
        ]
        self.current_provider_index = 0

    def call_with_fallback(self, func_name, *args, **kwargs):
        """å¸¦é™çº§çš„APIè°ƒç”¨"""
        for i in range(len(self.llm_providers)):
            provider = self.llm_providers[self.current_provider_index]

            try:
                result = getattr(provider['adapter'], func_name)(*args, **kwargs)
                if result['success']:
                    return result
            except Exception as e:
                logger.error(f"Provider {provider['name']} failed: {e}")
                self.current_provider_index = (self.current_provider_index + 1) % len(self.llm_providers)
                continue

        raise Exception("All API providers failed")
```

### 7.3 æˆæœ¬ä¼˜åŒ–ç­–ç•¥

```python
class CostOptimizer:
    """æˆæœ¬ä¼˜åŒ–å™¨"""

    # æ ¹æ®ç”¨æˆ·ç­‰çº§é€‰æ‹©æ¨¡å‹
    MODEL_STRATEGY = {
        "free": {
            "llm": "qwen-turbo",
            "embedding": "text-embedding-v2",
            "tts": "basic_voice"
        },
        "premium": {
            "llm": "qwen-plus",
            "embedding": "text-embedding-v2",
            "tts": "premium_voice"
        },
        "professional": {
            "llm": "qwen-max",
            "embedding": "text-embedding-v3",
            "tts": "custom_voice_clone"
        }
    }

    def get_model_config(self, user_tier):
        """æ ¹æ®ç”¨æˆ·ç­‰çº§è·å–æ¨¡å‹é…ç½®"""
        return self.MODEL_STRATEGY.get(user_tier, self.MODEL_STRATEGY["free"])

    def should_use_cache(self, message):
        """åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ç¼“å­˜å›å¤"""
        # å¸¸è§é—®å€™è¯­ä½¿ç”¨ç¼“å­˜
        greetings = ["ä½ å¥½", "hi", "hello", "åœ¨å—"]
        return any(g in message.lower() for g in greetings)
```

---

## 8. å®‰å…¨ä¸åˆè§„

### 8.1 API Keyç®¡ç†

```python
# config/security.py

import os
from cryptography.fernet import Fernet

class SecureConfig:
    """å®‰å…¨é…ç½®ç®¡ç†"""

    # ä½¿ç”¨ç¯å¢ƒå˜é‡ + åŠ å¯†
    ENCRYPTION_KEY = os.getenv("ENCRYPTION_KEY")

    @classmethod
    def encrypt_api_key(cls, api_key):
        f = Fernet(cls.ENCRYPTION_KEY)
        return f.encrypt(api_key.encode()).decode()

    @classmethod
    def decrypt_api_key(cls, encrypted_key):
        f = Fernet(cls.ENCRYPTION_KEY)
        return f.decrypt(encrypted_key.encode()).decode()

    @classmethod
    def get_api_key(cls, service_name):
        """å®‰å…¨è·å–API Key"""
        encrypted = os.getenv(f"{service_name.upper()}_API_KEY_ENCRYPTED")
        if encrypted:
            return cls.decrypt_api_key(encrypted)
        return os.getenv(f"{service_name.upper()}_API_KEY")
```

### 8.2 ç”¨æˆ·æ•°æ®éšç§

```python
class PrivacyProtection:
    """éšç§ä¿æŠ¤"""

    @staticmethod
    def anonymize_conversation(conversation):
        """å¯¹è¯æ•°æ®è„±æ•"""
        # ç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼ˆæ‰‹æœºå·ã€èº«ä»½è¯å·ç­‰ï¼‰
        import re
        text = conversation['content']

        # æ‰‹æœºå·è„±æ•
        text = re.sub(r'1[3-9]\d{9}', '***********', text)

        # èº«ä»½è¯å·è„±æ•
        text = re.sub(r'\d{17}[\dXx]', '******************', text)

        # é‚®ç®±è„±æ•
        text = re.sub(r'[\w.-]+@[\w.-]+', '***@***', text)

        return text

    @staticmethod
    def user_consent_required(func):
        """éœ€è¦ç”¨æˆ·æˆæƒçš„è£…é¥°å™¨"""
        def wrapper(user_id, *args, **kwargs):
            # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æˆæƒ
            if not UserConsent.check(user_id, func.__name__):
                raise PermissionError(f"User {user_id} has not consented to {func.__name__}")
            return func(user_id, *args, **kwargs)
        return wrapper
```

### 8.3 å†…å®¹å®¡æ ¸

```python
class ContentModeration:
    """å†…å®¹å®¡æ ¸"""

    def __init__(self):
        # ä½¿ç”¨é˜¿é‡Œäº‘å†…å®¹å®‰å…¨API
        self.client = self.init_aliyun_content_security()

    def check_user_input(self, text):
        """å®¡æ ¸ç”¨æˆ·è¾“å…¥"""
        result = self.client.text_scan(text)

        if result['risk'] == 'high':
            return {
                "allowed": False,
                "reason": "è¾“å…¥åŒ…å«è¿è§„å†…å®¹",
                "suggestion": result['suggestion']
            }

        return {"allowed": True}

    def check_ai_output(self, text):
        """å®¡æ ¸AIè¾“å‡º"""
        # æ£€æŸ¥AIç”Ÿæˆå†…å®¹æ˜¯å¦åˆè§„
        result = self.client.text_scan(text)

        if result['risk'] != 'pass':
            # è§¦å‘äººå·¥å®¡æ ¸æˆ–é‡æ–°ç”Ÿæˆ
            return self.regenerate_safe_response()

        return text
```

---

## 9. ç›‘æ§ä¸è¿ç»´

### 9.1 APIè°ƒç”¨ç›‘æ§

```python
import time
from functools import wraps

class APIMonitor:
    """APIç›‘æ§"""

    @staticmethod
    def monitor_api_call(api_name):
        def decorator(func):
            @wraps(func)
            def wrapper(*args, **kwargs):
                start_time = time.time()

                try:
                    result = func(*args, **kwargs)

                    # è®°å½•æˆåŠŸè°ƒç”¨
                    APIMetrics.record_success(
                        api_name=api_name,
                        latency=time.time() - start_time,
                        tokens_used=result.get('usage', {})
                    )

                    return result

                except Exception as e:
                    # è®°å½•å¤±è´¥è°ƒç”¨
                    APIMetrics.record_failure(
                        api_name=api_name,
                        error=str(e),
                        latency=time.time() - start_time
                    )
                    raise

            return wrapper
        return decorator
```

### 9.2 æˆæœ¬è¿½è¸ª

```python
class CostTracker:
    """æˆæœ¬è¿½è¸ª"""

    PRICING = {
        "qwen-turbo": {"input": 0.003, "output": 0.006},  # æ¯1K tokens
        "qwen-plus": {"input": 0.012, "output": 0.012},
        "text-embedding-v2": 0.0007,
        "tts": 4.0 / 10000  # æ¯å­—ç¬¦
    }

    def calculate_llm_cost(self, model, input_tokens, output_tokens):
        """è®¡ç®—LLMæˆæœ¬"""
        price = self.PRICING.get(model, {"input": 0, "output": 0})
        cost = (input_tokens / 1000 * price['input'] +
                output_tokens / 1000 * price['output'])
        return cost

    def log_cost(self, user_id, dh_id, service, cost):
        """è®°å½•æˆæœ¬"""
        CostLog.create(
            user_id=user_id,
            digital_human_id=dh_id,
            service=service,
            cost=cost,
            timestamp=datetime.utcnow()
        )
```

---

## æ€»ç»“

æœ¬æŠ€æœ¯æ–¹æ¡ˆå®Œå…¨åŸºäºå•†ä¸šè®¡åˆ’ä¹¦è¦æ±‚ï¼Œé‡‡ç”¨**å‚å•†APIä¼˜å…ˆ**ç­–ç•¥ï¼š

**æ ¸å¿ƒé€‰å‹**:
- âœ… **LLM**: é˜¿é‡Œäº‘é€šä¹‰åƒé—®ï¼ˆqwen-turbo/plusï¼‰
- âœ… **ASR**: ç§‘å¤§è®¯é£è¯­éŸ³å¬å†™ï¼ˆæ”¯æŒ202ç§æ–¹è¨€ï¼‰
- âœ… **TTS**: é˜¿é‡Œäº‘æ™ºèƒ½è¯­éŸ³ï¼ˆæ”¯æŒå£°éŸ³å…‹éš†ï¼‰
- âœ… **Embedding**: é˜¿é‡Œäº‘text-embedding-v2
- âœ… **å‘é‡DB**: Milvusï¼ˆå¼€æºè‡ªéƒ¨ç½²ï¼‰

**ä¼˜åŠ¿**:
1. **æˆæœ¬å¯æ§**: å…¨éƒ¨é‡‡ç”¨å›½äº§å‚å•†APIï¼Œä»·æ ¼é€æ˜
2. **ä¸­æ–‡ä¼˜åŒ–**: ä¸“ä¸ºä¸­æ–‡åœºæ™¯è®­ç»ƒï¼Œæ•ˆæœæ›´å¥½
3. **åˆè§„å®‰å…¨**: æ»¡è¶³å›½å†…ç›‘ç®¡è¦æ±‚
4. **æ˜“äºæ‰©å±•**: ç»Ÿä¸€é€‚é…å™¨æ¨¡å¼ï¼Œå¯å¿«é€Ÿåˆ‡æ¢å‚å•†

**ä¸‹ä¸€æ­¥**: åˆ¶å®šåˆ†é˜¶æ®µå¼€å‘è·¯çº¿å›¾
