<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ›å»ºæ•°å­—äºº - ç¡®è®¤åˆ›å»º</title>

  <!-- CSS -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/animations.css">

  <style>
    .create-page {
      min-height: 100vh;
      background: var(--color-bg-dark);
      display: flex;
      flex-direction: column;
    }

    .top-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-md) var(--spacing-2xl);
      background: var(--color-bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      position: sticky;
      top: 0;
      z-index: var(--z-dropdown);
    }

    .nav-back {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      color: var(--color-text-secondary);
      text-decoration: none;
      font-size: var(--font-size-body-large);
      transition: color var(--duration-fast) var(--ease-in-out);
    }

    .nav-back:hover {
      color: var(--color-primary-1);
    }

    .nav-title {
      font-size: var(--font-size-h4);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
    }

    .create-stepper {
      padding: var(--spacing-xl) var(--spacing-2xl);
      background: var(--color-bg-dark);
    }

    .create-content {
      flex: 1;
      padding: var(--spacing-2xl);
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
    }

    .content-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
    }

    .content-title {
      font-size: var(--font-size-h2);
      font-weight: var(--font-weight-bold);
      color: var(--color-text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .content-description {
      font-size: var(--font-size-body-large);
      color: var(--color-text-secondary);
    }

    /* å‘½ååŒºåŸŸ */
    .naming-section {
      background: var(--color-bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      text-align: center;
    }

    .avatar-preview {
      width: 100px;
      height: 100px;
      font-size: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--spacing-lg);
      border-radius: var(--radius-xl);
      background: var(--gradient-primary);
      box-shadow: var(--shadow-glow);
      animation: float 3s ease-in-out infinite;
    }

    .name-input-group {
      max-width: 400px;
      margin: 0 auto var(--spacing-md);
    }

    .name-label {
      font-size: var(--font-size-body-large);
      color: var(--color-text-primary);
      margin-bottom: var(--spacing-sm);
      font-weight: var(--font-weight-medium);
    }

    .name-input {
      width: 100%;
      height: 56px;
      padding: 16px 20px;
      font-size: var(--font-size-h4);
      color: var(--color-text-primary);
      background: rgba(15, 23, 42, 0.6);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      text-align: center;
      transition: all var(--duration-fast) var(--ease-in-out);
    }

    .name-input::placeholder {
      color: var(--color-text-placeholder);
    }

    .name-input:focus {
      border-color: var(--color-primary-1);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      outline: none;
    }

    .name-hint {
      font-size: var(--font-size-body-small);
      color: var(--color-text-disabled);
      margin-top: var(--spacing-sm);
    }

    /* æ‘˜è¦é¢„è§ˆ */
    .summary-section {
      background: var(--color-bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    .section-title {
      font-size: var(--font-size-h4);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      margin-bottom: var(--spacing-lg);
    }

    .summary-grid {
      display: grid;
      gap: var(--spacing-md);
    }

    .summary-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: rgba(30, 41, 59, 0.4);
      border-radius: var(--radius-md);
    }

    .summary-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient-primary);
      border-radius: var(--radius-md);
      font-size: 20px;
      flex-shrink: 0;
    }

    .summary-content {
      flex: 1;
      min-width: 0;
    }

    .summary-label {
      font-size: var(--font-size-body-small);
      color: var(--color-text-disabled);
      margin-bottom: var(--spacing-xs);
    }

    .summary-value {
      font-size: var(--font-size-body-large);
      color: var(--color-text-primary);
      font-weight: var(--font-weight-medium);
    }

    .summary-edit {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      color: var(--color-primary-1);
      font-size: var(--font-size-body-small);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-in-out);
      text-decoration: none;
      display: inline-block;
    }

    .summary-edit:hover {
      background: rgba(99, 102, 241, 0.1);
      border-color: var(--color-primary-1);
    }

    .create-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg) var(--spacing-2xl);
      background: var(--color-bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      position: sticky;
      bottom: 0;
    }

    .footer-left {
      display: flex;
      gap: var(--spacing-md);
    }

    .footer-right {
      display: flex;
      gap: var(--spacing-md);
    }

    .create-btn {
      min-width: 160px;
    }

    @media (max-width: 768px) {
      .top-nav,
      .create-stepper,
      .create-content,
      .create-footer {
        padding-left: var(--spacing-md);
        padding-right: var(--spacing-md);
      }

      .create-footer {
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .footer-left,
      .footer-right {
        width: 100%;
      }

      .footer-right {
        flex-direction: row-reverse;
      }

      .footer-right .btn {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="create-page page-transition">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="top-nav">
      <a href="create-dh-step4.html" class="nav-back">
        <span>â†</span>
        <span>è¿”å›</span>
      </a>
      <h2 class="nav-title">åˆ›å»ºæ•°å­—äºº</h2>
      <div style="width: 60px;"></div>
    </nav>

    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <div class="create-stepper">
      <div class="stepper">
        <div class="step completed">
          <div class="step-circle">1</div>
          <div class="step-label">é€‰æ‹©å½¢è±¡</div>
        </div>
        <div class="step-line"></div>
        <div class="step completed">
          <div class="step-circle">2</div>
          <div class="step-label">è®¾ç½®æ€§æ ¼</div>
        </div>
        <div class="step-line"></div>
        <div class="step completed">
          <div class="step-circle">3</div>
          <div class="step-label">é€‰æ‹©å£°éŸ³</div>
        </div>
        <div class="step-line"></div>
        <div class="step completed">
          <div class="step-circle">4</div>
          <div class="step-label">è®¾ç½®çŸ¥è¯†åº“</div>
        </div>
        <div class="step-line"></div>
        <div class="step active">
          <div class="step-circle">5</div>
          <div class="step-label">ç¡®è®¤åˆ›å»º</div>
        </div>
      </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="create-content">
      <div class="content-header">
        <h1 class="content-title gradient-text">æœ€åä¸€æ­¥ï¼Œç»™Taèµ·ä¸ªåå­—å§</h1>
        <p class="content-description">ç¡®è®¤ä½ çš„æ•°å­—äººè®¾ç½®ï¼Œå‡†å¤‡å¼€å§‹å¯¹è¯</p>
      </div>

      <!-- å‘½ååŒºåŸŸ -->
      <div class="naming-section">
        <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
        <div class="name-input-group">
          <label class="name-label">æ•°å­—äººæ˜µç§°</label>
          <input
            type="text"
            id="dhName"
            class="name-input"
            placeholder="ä¾‹å¦‚ï¼šå°æ™ºã€é˜¿é›…ã€å°åŠ©æ‰‹..."
            maxlength="20"
          >
          <div class="name-hint">è¿™ä¸ªåå­—å°†åœ¨å¯¹è¯ä¸­æ˜¾ç¤ºï¼Œå¯ä»¥éšæ—¶ä¿®æ”¹</div>
        </div>
      </div>

      <!-- é…ç½®æ‘˜è¦ -->
      <div class="summary-section">
        <h3 class="section-title">é…ç½®æ‘˜è¦</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-icon">ğŸ‘¤</div>
            <div class="summary-content">
              <div class="summary-label">å½¢è±¡</div>
              <div class="summary-value" id="avatarSummary">-</div>
            </div>
            <a href="create-dh-step1.html" class="summary-edit">ä¿®æ”¹</a>
          </div>

          <div class="summary-item">
            <div class="summary-icon">ğŸ­</div>
            <div class="summary-content">
              <div class="summary-label">æ€§æ ¼</div>
              <div class="summary-value" id="personalitySummary">-</div>
            </div>
            <a href="create-dh-step2.html" class="summary-edit">ä¿®æ”¹</a>
          </div>

          <div class="summary-item">
            <div class="summary-icon">ğŸ”Š</div>
            <div class="summary-content">
              <div class="summary-label">å£°éŸ³</div>
              <div class="summary-value" id="voiceSummary">-</div>
            </div>
            <a href="create-dh-step3.html" class="summary-edit">ä¿®æ”¹</a>
          </div>

          <div class="summary-item">
            <div class="summary-icon">ğŸ“š</div>
            <div class="summary-content">
              <div class="summary-label">çŸ¥è¯†åº“</div>
              <div class="summary-value" id="knowledgeSummary">-</div>
            </div>
            <a href="create-dh-step4.html" class="summary-edit">ä¿®æ”¹</a>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <footer class="create-footer">
      <div class="footer-left">
        <button class="btn btn-text" onclick="saveDraft()">
          ğŸ’¾ ä¿å­˜è‰ç¨¿
        </button>
      </div>
      <div class="footer-right">
        <button class="btn btn-secondary" onclick="window.location.href='create-dh-step4.html'">
          ä¸Šä¸€æ­¥
        </button>
        <button class="btn btn-primary create-btn" id="createBtn" onclick="createDigitalHuman()">
          ğŸ‰ åˆ›å»ºæ•°å­—äºº
        </button>
      </div>
    </footer>
  </div>

  <!-- è®¤è¯ç®¡ç† -->
  <script src="js/auth.js"></script>

  <script>
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!MindPalAuth.requireLogin(window.location.href)) {
      throw new Error('éœ€è¦ç™»å½•');
    }

    // åŠ è½½æ•°æ®
    let dhData = JSON.parse(sessionStorage.getItem('create_dh_data') || '{}');

    // æ€§æ ¼åç§°æ˜ å°„
    const personalityNames = {
      gentle: 'æ¸©æŸ”ä½“è´´',
      energetic: 'æ´»æ³¼å¼€æœ—',
      intellectual: 'çŸ¥æ€§ç†æ€§',
      humorous: 'å¹½é»˜é£è¶£',
      calm: 'æ²‰ç¨³å†·é™',
      creative: 'å¯Œæœ‰åˆ›æ„'
    };

    // å£°éŸ³åç§°æ˜ å°„
    const voiceNames = {
      xiaoya: 'å°é›…ï¼ˆæ¸©æŸ”ç”œç¾å¥³å£°ï¼‰',
      xiaoqing: 'å°é’ï¼ˆçŸ¥æ€§ä¼˜é›…å¥³å£°ï¼‰',
      xiaoxin: 'å°æ¬£ï¼ˆæ´»æ³¼å…ƒæ°”å¥³å£°ï¼‰',
      xiaoyu: 'å°å®‡ï¼ˆé˜³å…‰æ¸©æš–ç”·å£°ï¼‰',
      xiaozhi: 'å°æ™ºï¼ˆæ²‰ç¨³ç†æ€§ç”·å£°ï¼‰',
      xiaohao: 'å°æµ©ï¼ˆå¹½é»˜é£è¶£ç”·å£°ï¼‰'
    };

    // åˆå§‹åŒ–é¡µé¢
    function initPage() {
      // æ˜¾ç¤ºå¤´åƒ
      if (dhData.avatarEmoji) {
        document.getElementById('avatarPreview').textContent = dhData.avatarEmoji;
      }

      // æ˜¾ç¤ºå½¢è±¡æ‘˜è¦
      if (dhData.avatar) {
        const avatarElement = document.querySelector(`[data-avatar="${dhData.avatar}"]`);
        if (avatarElement) {
          const avatarLabel = avatarElement.querySelector('.avatar-label')?.textContent || dhData.avatar;
          document.getElementById('avatarSummary').textContent = avatarLabel;
        }
      }

      // æ˜¾ç¤ºæ€§æ ¼æ‘˜è¦
      if (dhData.personality) {
        const personalityName = personalityNames[dhData.personality] || dhData.personality;
        const traits = dhData.traits;
        let summary = personalityName;

        if (traits) {
          const topTraits = Object.entries(traits)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 2)
            .map(([key, value]) => {
              const traitNames = {
                liveliness: 'æ´»æ³¼',
                humor: 'å¹½é»˜',
                empathy: 'å…±æƒ…',
                initiative: 'ä¸»åŠ¨',
                creativity: 'åˆ›æ„'
              };
              return traitNames[key];
            })
            .join('ã€');

          if (topTraits) {
            summary += ` Â· ${topTraits}`;
          }
        }

        document.getElementById('personalitySummary').textContent = summary;
      }

      // æ˜¾ç¤ºå£°éŸ³æ‘˜è¦
      if (dhData.voice) {
        const voiceName = voiceNames[dhData.voice] || dhData.voice;
        let summary = voiceName;

        if (dhData.voiceParams) {
          const params = dhData.voiceParams;
          if (params.speed && params.speed !== 1.0) {
            summary += ` Â· ${params.speed}xè¯­é€Ÿ`;
          }
        }

        document.getElementById('voiceSummary').textContent = summary;
      }

      // æ˜¾ç¤ºçŸ¥è¯†åº“æ‘˜è¦
      if (dhData.knowledge) {
        const fileCount = dhData.knowledge.files?.length || 0;
        const urlCount = dhData.knowledge.urls?.length || 0;
        const total = fileCount + urlCount;

        if (total > 0) {
          const parts = [];
          if (fileCount > 0) parts.push(`${fileCount}ä¸ªæ–‡æ¡£`);
          if (urlCount > 0) parts.push(`${urlCount}ä¸ªé“¾æ¥`);
          document.getElementById('knowledgeSummary').textContent = parts.join('ã€');
        } else {
          document.getElementById('knowledgeSummary').textContent = 'æš‚æœªæ·»åŠ ï¼ˆå¯åç»­æ·»åŠ ï¼‰';
        }
      } else {
        document.getElementById('knowledgeSummary').textContent = 'æš‚æœªæ·»åŠ ï¼ˆå¯åç»­æ·»åŠ ï¼‰';
      }

      // æ¢å¤å·²ä¿å­˜çš„åå­—
      if (dhData.name) {
        document.getElementById('dhName').value = dhData.name;
      }
    }

    // å®æ—¶ä¿å­˜åå­—
    document.getElementById('dhName').addEventListener('input', function() {
      dhData.name = this.value.trim();
      sessionStorage.setItem('create_dh_data', JSON.stringify(dhData));
    });

    // ä¿å­˜è‰ç¨¿
    function saveDraft() {
      dhData.isDraft = true;
      dhData.lastSaved = new Date().toISOString();

      const drafts = JSON.parse(localStorage.getItem('mindpal_dh_drafts') || '[]');
      const existingIndex = drafts.findIndex(d => d.draftId === dhData.draftId);

      if (existingIndex >= 0) {
        drafts[existingIndex] = dhData;
      } else {
        dhData.draftId = dhData.draftId || Date.now();
        drafts.push(dhData);
      }

      localStorage.setItem('mindpal_dh_drafts', JSON.stringify(drafts));
      alert('è‰ç¨¿å·²ä¿å­˜ï¼');
    }

    // åˆ›å»ºæ•°å­—äºº
    async function createDigitalHuman() {
      const name = document.getElementById('dhName').value.trim();

      // éªŒè¯åå­—
      if (!name) {
        alert('è¯·ç»™ä½ çš„æ•°å­—äººèµ·ä¸ªåå­—');
        document.getElementById('dhName').focus();
        return;
      }

      // éªŒè¯å¿…å¡«é¡¹
      if (!dhData.avatar) {
        alert('è¯·å…ˆé€‰æ‹©å½¢è±¡');
        window.location.href = 'create-dh-step1.html';
        return;
      }

      if (!dhData.voice) {
        alert('è¯·å…ˆé€‰æ‹©å£°éŸ³');
        window.location.href = 'create-dh-step3.html';
        return;
      }

      dhData.name = name;

      const createBtn = document.getElementById('createBtn');
      createBtn.classList.add('btn-loading');
      createBtn.disabled = true;

      try {
        // è°ƒç”¨åç«¯APIåˆ›å»ºæ•°å­—äºº
        const token = MindPalAuth.getAuthToken();
        if (!token) {
          alert('è¯·å…ˆç™»å½•');
          window.location.href = 'index.html';
          return;
        }

        const response = await fetch('http://localhost:5000/api/digital-humans', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            name: dhData.name,
            avatar: dhData.avatar,
            avatarEmoji: dhData.avatarEmoji,
            avatarCustom: dhData.avatarCustom,
            personality: dhData.personality,
            traits: dhData.traits,
            customPersonality: dhData.customPersonality,
            voice: dhData.voice,
            voiceParams: dhData.voiceParams
          })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'åˆ›å»ºå¤±è´¥');
        }

        const digitalHuman = result.data;

        // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä»¥ä¾¿ç¦»çº¿è®¿é—®
        const digitalHumans = JSON.parse(localStorage.getItem('mindpal_digital_humans') || '[]');
        digitalHumans.push(digitalHuman);
        localStorage.setItem('mindpal_digital_humans', JSON.stringify(digitalHumans));

        // æ¸…é™¤ä¼šè¯æ•°æ®
        sessionStorage.removeItem('create_dh_data');

        // ä»è‰ç¨¿ä¸­åˆ é™¤
        if (dhData.draftId) {
          const drafts = JSON.parse(localStorage.getItem('mindpal_dh_drafts') || '[]');
          const filteredDrafts = drafts.filter(d => d.draftId !== dhData.draftId);
          localStorage.setItem('mindpal_dh_drafts', JSON.stringify(filteredDrafts));
        }

        // è·³è½¬åˆ°å¯¹è¯é¡µé¢
        window.location.href = `chat.html?id=${digitalHuman.id}`;

      } catch (error) {
        console.error('åˆ›å»ºå¤±è´¥:', error);
        alert(error.message || 'åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        createBtn.classList.remove('btn-loading');
        createBtn.disabled = false;
      }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', initPage);
  </script>
</body>
</html>
