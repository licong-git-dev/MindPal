<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¹è¯ - MindPal</title>

  <!-- CSS -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/animations.css">

  <style>
    .chat-page {
      height: 100vh;
      background: var(--color-bg-dark);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* é¡¶éƒ¨æ  */
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--color-bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      height: 60px;
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .back-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--color-text-secondary);
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: all var(--duration-fast) var(--ease-in-out);
    }

    .back-btn:hover {
      background: rgba(99, 102, 241, 0.1);
      color: var(--color-primary-1);
    }

    .dh-info-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .dh-avatar-small {
      width: 36px;
      height: 36px;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient-primary);
      border-radius: var(--radius-md);
    }

    .dh-name-header {
      font-size: var(--font-size-body-large);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
    }

    .header-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    /* æ•°å­—äººæ˜¾ç¤ºåŒºåŸŸ 60vh */
    .dh-display {
      height: 60vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0) 0%, var(--color-bg-dark) 100%);
    }

    .dh-avatar-large {
      width: 200px;
      height: 200px;
      font-size: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-2xl);
      background: var(--gradient-primary);
      box-shadow: var(--shadow-glow);
      animation: breathing 2s ease-in-out infinite;
      margin-bottom: var(--spacing-lg);
    }

    .dh-emotion {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--color-bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-full);
      font-size: var(--font-size-body-small);
      color: var(--color-text-secondary);
    }

    .emotion-icon {
      font-size: 20px;
    }

    .dh-status {
      font-size: var(--font-size-body);
      color: var(--color-text-secondary);
      text-align: center;
      padding: var(--spacing-sm) var(--spacing-lg);
      background: var(--color-bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius-full);
    }

    .dh-status.speaking {
      color: var(--color-primary-1);
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* å¯¹è¯åŒºåŸŸ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--color-bg-dark);
      overflow: hidden;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .message {
      display: flex;
      gap: var(--spacing-sm);
      animation: slideIn var(--duration-fast) var(--ease-custom);
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-content.user {
      background: var(--gradient-primary);
      color: #FFFFFF;
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px 12px 4px 12px;
      word-wrap: break-word;
      line-height: 1.6;
    }

    .message-content.assistant {
      background: var(--color-bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: var(--color-text-primary);
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px 12px 12px 4px;
      word-wrap: break-word;
      line-height: 1.6;
    }

    /* è¾“å…¥åŒºåŸŸ */
    .input-container {
      padding: var(--spacing-lg);
      background: var(--color-bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      flex-shrink: 0;
    }

    .input-wrapper {
      display: flex;
      gap: var(--spacing-md);
      align-items: flex-end;
    }

    .message-input {
      flex: 1;
      min-height: 48px;
      max-height: 120px;
      padding: 12px 16px;
      font-size: var(--font-size-body-large);
      color: var(--color-text-primary);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      resize: none;
      font-family: inherit;
      line-height: 1.6;
      transition: all var(--duration-fast) var(--ease-in-out);
    }

    .message-input::placeholder {
      color: var(--color-text-placeholder);
    }

    .message-input:focus {
      border-color: var(--color-primary-1);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      outline: none;
    }

    .voice-btn {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      font-size: 20px;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-in-out);
      flex-shrink: 0;
    }

    .voice-btn:hover {
      background: rgba(99, 102, 241, 0.1);
      border-color: var(--color-primary-1);
      color: var(--color-primary-1);
    }

    .voice-btn.recording {
      background: var(--gradient-primary);
      border-color: transparent;
      color: #FFFFFF;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .send-btn {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient-primary);
      border: none;
      border-radius: var(--radius-full);
      font-size: 20px;
      color: #FFFFFF;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-in-out);
      box-shadow: var(--shadow);
      flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
      transform: scale(1.1);
      box-shadow: var(--shadow-glow);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .dh-display {
        height: 50vh;
      }

      .dh-avatar-large {
        width: 140px;
        height: 140px;
        font-size: 100px;
      }

      .message-content.user,
      .message-content.assistant {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <div class="chat-page page-transition">
    <!-- é¡¶éƒ¨æ  -->
    <header class="chat-header">
      <div class="header-left">
        <button class="back-btn" onclick="window.location.href='dh-list.html'">
          â†
        </button>
        <div class="dh-info-header">
          <div class="dh-avatar-small" id="dhAvatarSmall">ğŸ‘¤</div>
          <div class="dh-name-header" id="dhNameHeader">æ•°å­—äºº</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-icon" onclick="clearChat()" title="æ¸…é™¤å¯¹è¯">
          ğŸ—‘ï¸
        </button>
        <button class="btn btn-icon" onclick="toggleSettings()" title="è®¾ç½®">
          âš™ï¸
        </button>
      </div>
    </header>

    <!-- æ•°å­—äººæ˜¾ç¤ºåŒºåŸŸ -->
    <div class="dh-display">
      <div class="dh-emotion" id="emotionDisplay">
        <span class="emotion-icon">ğŸ˜Š</span>
        <span>å¿ƒæƒ…æ„‰æ‚¦</span>
      </div>
      <div class="dh-avatar-large" id="dhAvatarLarge">ğŸ‘¤</div>
      <div class="dh-status" id="dhStatus">åœ¨çº¿</div>
    </div>

    <!-- å¯¹è¯åŒºåŸŸ -->
    <div class="chat-container">
      <div class="messages-container" id="messagesContainer">
        <!-- æ¶ˆæ¯å°†åŠ¨æ€æ·»åŠ  -->
      </div>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="input-container">
        <div class="input-wrapper">
          <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceInput()" title="è¯­éŸ³è¾“å…¥">
            ğŸ¤
          </button>
          <textarea
            id="messageInput"
            class="message-input"
            placeholder="è¾“å…¥æ¶ˆæ¯..."
            rows="1"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
            â¤
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // è·å–URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const dhId = parseInt(urlParams.get('id'));

    // åŠ è½½æ•°å­—äººæ•°æ®
    let currentDH = null;
    let messages = [];
    let isRecording = false;

    function loadDigitalHuman() {
      const digitalHumans = JSON.parse(localStorage.getItem('mindpal_digital_humans') || '[]');
      currentDH = digitalHumans.find(dh => dh.id === dhId);

      if (!currentDH) {
        alert('æ•°å­—äººä¸å­˜åœ¨');
        window.location.href = 'dh-list.html';
        return;
      }

      // æ›´æ–°UI
      document.getElementById('dhNameHeader').textContent = currentDH.name;
      document.getElementById('dhAvatarSmall').textContent = currentDH.avatarEmoji || 'ğŸ‘¤';
      document.getElementById('dhAvatarLarge').textContent = currentDH.avatarEmoji || 'ğŸ‘¤';

      // åŠ è½½å†å²æ¶ˆæ¯
      loadMessages();
    }

    // åŠ è½½æ¶ˆæ¯
    function loadMessages() {
      const messagesKey = `mindpal_messages_${dhId}`;
      messages = JSON.parse(localStorage.getItem(messagesKey) || '[]');

      renderMessages();

      if (messages.length === 0) {
        // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
        addMessage('assistant', `ä½ å¥½ï¼æˆ‘æ˜¯${currentDH.name}ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ`);
      }
    }

    // æ¸²æŸ“æ¶ˆæ¯
    function renderMessages() {
      const container = document.getElementById('messagesContainer');
      container.innerHTML = '';

      messages.forEach(msg => {
        const messageEl = createMessageElement(msg);
        container.appendChild(messageEl);
      });

      // æ»šåŠ¨åˆ°åº•éƒ¨
      container.scrollTop = container.scrollHeight;
    }

    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    function createMessageElement(msg) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${msg.role}`;

      const contentDiv = document.createElement('div');
      contentDiv.className = `message-content ${msg.role}`;
      contentDiv.textContent = msg.content;

      messageDiv.appendChild(contentDiv);
      return messageDiv;
    }

    // æ·»åŠ æ¶ˆæ¯
    function addMessage(role, content) {
      const message = {
        role: role,
        content: content,
        timestamp: new Date().toISOString()
      };

      messages.push(message);
      saveMessages();

      const messageEl = createMessageElement(message);
      document.getElementById('messagesContainer').appendChild(messageEl);

      // æ»šåŠ¨åˆ°åº•éƒ¨
      const container = document.getElementById('messagesContainer');
      container.scrollTop = container.scrollHeight;

      // æ›´æ–°æ•°å­—äººç»Ÿè®¡
      updateDHStats();
    }

    // ä¿å­˜æ¶ˆæ¯
    function saveMessages() {
      const messagesKey = `mindpal_messages_${dhId}`;
      localStorage.setItem(messagesKey, JSON.stringify(messages));
    }

    // æ›´æ–°æ•°å­—äººç»Ÿè®¡
    function updateDHStats() {
      const digitalHumans = JSON.parse(localStorage.getItem('mindpal_digital_humans') || '[]');
      const dhIndex = digitalHumans.findIndex(dh => dh.id === dhId);

      if (dhIndex >= 0) {
        digitalHumans[dhIndex].lastChatAt = new Date().toISOString();
        digitalHumans[dhIndex].messageCount = messages.length;
        localStorage.setItem('mindpal_digital_humans', JSON.stringify(digitalHumans));
      }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();

      if (!content) return;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage('user', content);
      input.value = '';
      adjustTextareaHeight();
      document.getElementById('sendBtn').disabled = true;

      // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥çŠ¶æ€
      const status = document.getElementById('dhStatus');
      status.textContent = 'æ­£åœ¨è¾“å…¥...';
      status.classList.add('speaking');

      // è°ƒç”¨åç«¯APIè·å–AIå›å¤
      try {
        await generateReply(content);
        status.textContent = 'åœ¨çº¿';
        status.classList.remove('speaking');
        document.getElementById('sendBtn').disabled = false;
      } catch (error) {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        addMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚è¯·ç¨åå†è¯•ã€‚');
        status.textContent = 'åœ¨çº¿';
        status.classList.remove('speaking');
        document.getElementById('sendBtn').disabled = false;
      }
    }

    // ç”ŸæˆAIå›å¤ï¼ˆè°ƒç”¨åç«¯APIï¼‰
    async function generateReply(userMessage) {
      const token = localStorage.getItem('mindpal_token');
      if (!token) {
        throw new Error('æœªç™»å½•');
      }

      const response = await fetch('http://localhost:5000/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          dhId: parseInt(dhId),
          message: userMessage
        })
      });

      if (!response.ok) {
        throw new Error('APIè¯·æ±‚å¤±è´¥');
      }

      // å¤„ç†æµå¼å“åº”
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let aiMessage = '';
      let messageElement = null;

      while (true) {
        const { done, value } = await reader.read();

        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            try {
              const data = JSON.parse(line.slice(6));

              if (data.chunk) {
                aiMessage += data.chunk;

                // å¦‚æœè¿˜æ²¡æœ‰åˆ›å»ºæ¶ˆæ¯å…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª
                if (!messageElement) {
                  const messagesContainer = document.getElementById('messagesContainer');
                  const messageDiv = document.createElement('div');
                  messageDiv.className = 'message assistant';
                  messageDiv.innerHTML = `
                    <div class="message-avatar">${currentDH.avatarEmoji}</div>
                    <div class="message-bubble"></div>
                  `;
                  messagesContainer.appendChild(messageDiv);
                  messageElement = messageDiv.querySelector('.message-bubble');
                  scrollToBottom();
                }

                // æ›´æ–°æ¶ˆæ¯å†…å®¹
                messageElement.textContent = aiMessage;
                scrollToBottom();
              } else if (data.done) {
                // æ¶ˆæ¯å®Œæˆï¼Œä¿å­˜åˆ°æœ¬åœ°
                messages.push({
                  role: 'assistant',
                  content: aiMessage,
                  timestamp: new Date().toISOString(),
                  emotion: data.emotion || 'neutral'
                });
                saveMessages();
              } else if (data.error) {
                throw new Error(data.error);
              }
            } catch (e) {
              console.error('è§£ææµå¼æ•°æ®å¤±è´¥:', e);
            }
          }
        }
      }
    }

    // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
    const messageInput = document.getElementById('messageInput');
    messageInput.addEventListener('input', function() {
      adjustTextareaHeight();

      // å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = !this.value.trim();
    });

    function adjustTextareaHeight() {
      const textarea = document.getElementById('messageInput');
      textarea.style.height = '48px';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // å›è½¦å‘é€
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // è¯­éŸ³è¾“å…¥
    function toggleVoiceInput() {
      const voiceBtn = document.getElementById('voiceBtn');

      if (isRecording) {
        // åœæ­¢å½•éŸ³
        isRecording = false;
        voiceBtn.classList.remove('recording');
        voiceBtn.textContent = 'ğŸ¤';
        alert('è¯­éŸ³è¯†åˆ«åŠŸèƒ½å¼€å‘ä¸­...');
      } else {
        // å¼€å§‹å½•éŸ³
        isRecording = true;
        voiceBtn.classList.add('recording');
        voiceBtn.textContent = 'â¸';
      }
    }

    // æ¸…é™¤å¯¹è¯
    function clearChat() {
      if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
        return;
      }

      messages = [];
      saveMessages();
      renderMessages();

      // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
      addMessage('assistant', `å¯¹è¯å·²æ¸…é™¤ã€‚æœ‰ä»€ä¹ˆæ–°çš„è¯é¢˜æƒ³èŠå—ï¼Ÿ`);
    }

    // è®¾ç½®
    function toggleSettings() {
      alert('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
    }

    // é¡µé¢åŠ è½½
    window.addEventListener('load', loadDigitalHuman);
  </script>
</body>
</html>
